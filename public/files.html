<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ファイル一覧 - Uploader</title>
    <link rel="stylesheet" href="/css/main.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  </head>
  <body>
    <div class="app-container">
      <header class="header">
        <div class="header-content">
          <h1 class="app-title">ファイル一覧</h1>
          <nav class="nav">
            <a href="/" class="nav-item">
              <span class="material-icons">home</span>
              <span>ホーム</span>
            </a>
            <a href="/upload" class="nav-item">
              <span class="material-icons">cloud_upload</span>
              <span>アップロード</span>
            </a>
            <a href="/files" class="nav-item active">
              <span class="material-icons">folder</span>
              <span>ファイル</span>
            </a>
          </nav>
          <div class="header-actions">
            <button class="theme-toggle" id="themeToggle" title="テーマを切り替え">
              <span class="material-icons">dark_mode</span>
            </button>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
              <span class="material-icons">menu</span>
            </button>
          </div>
        </div>
      </header>

      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
          <h2>メニュー</h2>
          <button class="mobile-menu-close" onclick="toggleMobileMenu()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <nav class="mobile-menu-nav">
          <a href="/" class="nav-item">
            <span class="material-icons">home</span>
            <span>ホーム</span>
          </a>
          <a href="/upload" class="nav-item">
            <span class="material-icons">cloud_upload</span>
            <span>アップロード</span>
          </a>
          <a href="/files" class="nav-item active">
            <span class="material-icons">folder</span>
            <span>ファイル</span>
          </a>
        </nav>
      </div>

      <main class="main-content">
        <div class="files-list">
          <div class="section-header">
            <h3>アップロードされたファイル</h3>
            <a href="/upload" class="btn btn-primary">
              <span class="material-icons">cloud_upload</span>
              新しいファイルをアップロード
            </a>
          </div>

          <div class="file-grid" id="filesGrid">
            <div class="empty-state">
              <div class="empty-icon">
                <span class="material-icons">folder_open</span>
              </div>
              <p>まだファイルがアップロードされていません</p>
              <a href="/upload" class="btn btn-primary">最初のファイルをアップロード</a>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div class="popup-overlay" id="fileNamePopup">
      <div class="popup">
        <div class="popup-header">
          <h3>ファイル名</h3>
          <button class="popup-close" onclick="closeFileNamePopup()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="popup-content">
          <p id="fullFileName"></p>
        </div>
      </div>
    </div>

    <div class="popup-overlay" id="renamePopup">
      <div class="popup">
        <div class="popup-header">
          <h3>ファイル名を変更</h3>
          <button class="popup-close" onclick="closeRenamePopup()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="popup-content">
          <div class="form-group">
            <label for="newFileName">新しいファイル名</label>
            <input type="text" id="newFileName" placeholder="ファイル名を入力してください" />
          </div>
        </div>
        <div class="popup-actions">
          <button class="btn btn-cancel" onclick="closeRenamePopup()">キャンセル</button>
          <button class="btn btn-confirm" onclick="confirmRename()">変更</button>
        </div>
      </div>
    </div>

    <div class="popup-overlay" id="sharePopup">
      <div class="popup">
        <div class="popup-header">
          <h3>ファイルを共有</h3>
          <button class="popup-close" onclick="closeSharePopup()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="popup-content">
          <div class="form-group">
            <label for="shareUrl">共有URL</label>
            <input type="text" id="shareUrl" readonly />
          </div>
        </div>
        <div class="popup-actions">
          <button class="btn btn-primary" onclick="copyShareUrl()">URLをコピー</button>
        </div>
      </div>
    </div>

    <div class="popup-overlay" id="deletePopup">
      <div class="popup">
        <div class="popup-header">
          <h3>ファイル削除の確認</h3>
          <button class="popup-close" onclick="closeDeletePopup()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="popup-content">
          <p id="deleteConfirmMessage"></p>
        </div>
        <div class="popup-actions">
          <button class="btn btn-cancel" onclick="closeDeletePopup()">キャンセル</button>
          <button class="btn btn-confirm" onclick="confirmDelete()">削除</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const filesGrid = document.getElementById('filesGrid');
      const themeToggle = document.getElementById('themeToggle');
      const fileNamePopup = document.getElementById('fileNamePopup');
      const fullFileName = document.getElementById('fullFileName');
      const renamePopup = document.getElementById('renamePopup');
      const sharePopup = document.getElementById('sharePopup');
      const deletePopup = document.getElementById('deletePopup');
      const newFileName = document.getElementById('newFileName');
      const shareUrl = document.getElementById('shareUrl');
      const toast = document.getElementById('toast');

      let currentTheme = 'auto';
      let currentFile = null;

      function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'auto';
        setTheme(savedTheme);
        updateThemeToggleIcon();
      }

      function setTheme(theme) {
        currentTheme = theme;
        localStorage.setItem('theme', theme);

        if (theme === 'auto') {
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-theme', theme);
        }
      }

      function updateThemeToggleIcon() {
        const icon = themeToggle.querySelector('.material-icons');
        if (currentTheme === 'dark') {
          icon.textContent = 'light_mode';
        } else if (currentTheme === 'light') {
          icon.textContent = 'dark_mode';
        } else {
          icon.textContent = 'brightness_auto';
        }
      }

      function toggleTheme() {
        if (currentTheme === 'auto') {
          setTheme('light');
        } else if (currentTheme === 'light') {
          setTheme('dark');
        } else {
          setTheme('auto');
        }
        updateThemeToggleIcon();
      }

      function showFileNamePopup(fileName) {
        fullFileName.textContent = fileName;
        fileNamePopup.classList.add('show');
      }

      function closeFileNamePopup() {
        fileNamePopup.classList.remove('show');
        const actionButton = document.querySelector('#fileNamePopup .popup-actions .btn-confirm');
        if (actionButton) {
          actionButton.disabled = false;
        }
      }

      function showRenamePopup(file) {
        currentFile = file;
        newFileName.value = file.originalName;
        renamePopup.classList.add('show');
      }

      function closeRenamePopup() {
        renamePopup.classList.remove('show');
        currentFile = null;
        const actionButton = document.querySelector('#renamePopup .popup-actions .btn-confirm');
        if (actionButton) {
          actionButton.disabled = false;
        }
      }

      function showSharePopup(file) {
        const url = `${window.location.origin}/files/${encodeURIComponent(file.originalName)}`;
        shareUrl.value = url;
        sharePopup.classList.add('show');
      }

      function closeSharePopup() {
        sharePopup.classList.remove('show');
        const actionButton = document.querySelector('#sharePopup .popup-actions .btn-confirm');
        if (actionButton) {
          actionButton.disabled = false;
        }
      }

      function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const filenameLower = filename.toLowerCase();

        const imageExts = [
          'jpg',
          'jpeg',
          'png',
          'gif',
          'bmp',
          'webp',
          'svg',
          'ico',
          'tiff',
          'tif',
          'heic',
          'heif',
          'raw',
          'cr2',
          'nef',
          'arw',
          'psd',
          'ai',
          'eps',
          'ps',
          'xcf',
          'kra',
          'clip',
          'procreate',
          'ase',
          'aseprite',
        ];

        const docExts = [
          'doc',
          'docx',
          'odt',
          'rtf',
          'odp',
          'ppt',
          'pptx',
          'md',
          'pages',
          'key',
          'epub',
          'mobi',
          'azw',
          'azw3',
          'fb2',
          'tex',
          'latex',
          'rst',
          'org',
          'abw',
          'zabw',
          'fodt',
          'ott',
          'dotx',
          'dotm',
          'docm',
          'dot',
        ];

        const sheetExts = [
          'xls',
          'xlsx',
          'ods',
          'csv',
          'tsv',
          'fods',
          'ots',
          'xlsm',
          'xlsb',
          'xltx',
          'xltm',
          'xlt',
          'xlam',
          'xla',
          'xll',
          'xlw',
          'gnumeric',
        ];

        const exeExts = [
          'exe',
          'dll',
          'so',
          'dylib',
          'jar',
          'app',
          'appimage',
          'appx',
          'apk',
          'deb',
          'rpm',
          'msi',
          'bat',
          'sh',
          'command',
          'com',
          'msc',
          'pif',
          'scr',
          'cpl',
          'gadget',
          'msp',
          'mst',
          'paf',
          'rpmnew',
          'rpmorig',
          'rpmsave',
          'run',
          'vb',
          'vbs',
          'ws',
          'wsf',
          'wsh',
          'bin',
        ];

        const archiveExts = [
          'zst',
          'zip',
          'rar',
          '7z',
          'tar',
          'gz',
          'bz2',
          'xz',
          'lzma',
          'lz4',
          'iso',
          'dmg',
          'pkg',
          'cab',
          'arj',
          'lzh',
          'lha',
          'lzx',
          'lz',
          'lzo',
          'rz',
          'sz',
          'zoo',
          'zipx',
          'ace',
          'alz',
          'arc',
          'b1',
          'b6z',
          'ba',
          'bh',
          'car',
          'dar',
          'dd',
          'dgc',
          'ear',
          'gca',
          'ha',
          'hki',
          'ice',
          'kgb',
          'lbr',
          'pak',
          'partimg',
          'pea',
          'pim',
          'pup',
          'qda',
          'rk',
          's7z',
          'sda',
          'sea',
          'sen',
          'sfx',
          'shk',
          'sit',
          'sitx',
          'sqx',
          'tbz2',
          'tgz',
          'tlz',
          'txz',
          'tz',
          'war',
          'wim',
          'xar',
          'z',
          'zpaq',
          'zz',
        ];

        const codeExts = [
          'py',
          'pyw',
          'pyi',
          'pyc',
          'pyd',
          'pyo',
          'pyt',
          'pyz',
          'pyzw',

          'java',
          'class',
          'jmod',
          'jsp',
          'jspx',
          'jspf',

          'c',
          'h',
          'i',
          'ii',
          'cpp',
          'cc',
          'cxx',
          'c++',
          'hpp',
          'hh',
          'hxx',
          'h++',
          'inl',
          'ipp',
          'cs',
          'csx',
          'csproj',
          'sln',
          'slnf',
          'props',
          'targets',
          'csproj.user',

          'php',
          'phtml',
          'php3',
          'php4',
          'php5',
          'php7',
          'phps',
          'phpt',

          'rb',
          'rbw',
          'rake',
          'gemspec',
          'podspec',
          'thor',
          'irbrc',
          'pryrc',
          'go',
          'mod',
          'sum',
          'work',
          'tmpl',
          'tpl',
          'tmpl.html',
          'tpl.html',
          'rs',
          'rlib',
          'rs.in',
          'swiftmodule',
          'swiftdoc',
          'swiftsourceinfo',
          'swiftinterface',
          'kt',
          'ktm',
          'kts.sed',
          'dart',
          'dart.snapshot',
          'sh',
          'bash',
          'zsh',
          'tcsh',
          'ksh',
          'fish',
          'cshrc',
          'bashrc',
          'ps1',
          'ps1xml',
          'psc1',
          'psd1',
          'pssc',
          'cdxml',
          'js',
          'jsx',
          'mjs',
          'cjs',
          'es6',
          'jsm',
          'pac',
          'ts',
          'tsx',
          'mts',
          'cts',
          'd.ts',
          'd.cts',
          'd.mts',
          'm',
          'mm',
          'M',
          'scala',
          'sc',
          'scala.sbt',
          'groovy',
          'gvy',
          'gradle.kts',
          'gradle.properties',
          'pl',
          'pm',
          'ph',
          'plx',
          'al',
          'perl',
          'psgi',
          'rds',
          'rda',
          'rproj',
          'rhistory',
          'rmd',
          'rprofile',
          'lua',
          'rockspec',
          'tm',
          'tclshrc',
          'tclshrc.tcl',
          'tclshrc.tk',
          'sql',
          'ddl',
          'dml',
          'pks',
          'asm',
          's',
          'sx',
          'inc',
          'v',
          'vh',
          'vhd',
          'vhdl',
          'vho',
          'vhs',
          'vht',
          'vhw',
          'vinc',
          'vp',
          'vst',
          'vsproj',
          'vssscc',
          'coffee',
          'litcoffee',
          'coffee.md',
          'cson',
          'iced',
          'pde',
          'ino',
          'nix',
          'nixos',
          'nix.in',
          'nixpkgs',
          'nixpkg',
          'nix-expr',
          'ninja',
          'ninja-build',
          'rkt',
          'rktl',
          'rktd',
          'rkt~',
          'rktl~',
          'rktd~',
          'rkt.~',
          'rktl.~',
          'rktd.~',
          'scm',
          'ss',
          'sld',
          'sls',
          'sps',
          'sps~',
          'sps.~',
          'sps.scm',
          'sps.ss',
          'lisp',
          'lsp',
          'l',
          'lisp~',
          'lsp~',
          'l~',
          'lisp.~',
          'lsp.~',
          'l.~',
          'cl',
          'cl~',
          'cl.~',
          'clj',
          'cljc',
          'cljs',
          'cljscm',
          'cljx',
          'clj~',
          'cljc~',
          'cljs~',
          'cljscm~',
          'cljx~',
          'edn',
          'edn~',
          'edn.~',
          'ex',
          'exs',
          'eex',
          'leex',
          'heex',
          'ex.~',
          'exs.~',
          'eex.~',
          'leex.~',
          'heex.~',
          'erl',
          'hrl',
          'es',
          'escript',
          'xrl',
          'yrl',
          'app.src',
          'appup.src',
          'appup.script',
          'appup.script.src',
          'yaws',
          'yaws.~',
          'yaws.erl',
          'yaws.hrl',
          'yaws.conf',
          'yaws.conf.~',
          'yaws.conf.local',
          'yaws.conf.local.~',
          're',
          'rei',
          're.~',
          'rei.~',
          're.ml',
          're.mli',
          're.ml.~',
          're.mli.~',
          'ml',
          'mli',
          'mll',
          'mly',
          'ml.~',
          'mli.~',
          'mll.~',
          'mly.~',
          'fs',
          'fsi',
          'fsx',
          'fsscript',
          'fs.~',
          'fsi.~',
          'fsx.~',
          'fsscript.~',
          'hs',
          'lhs',
          'hs-boot',
          'lhs-boot',
          'hs.~',
          'lhs.~',
          'hs-boot.~',
          'lhs-boot.~',
          'purs',
          'purs.~',
          'purs.hs',
          'purs.~.hs',
          'purs.~.purs',
          'purs.hs.~',
          'purs.~.hs.~',
          'purs.~.purs.~',
        ];

        const gameExts = [
          'mcpack',
          'mcworld',
          'mctemplate',
          'mcstructure',
          'mcaddon',
          'mcfunction',
          'mcmeta',
          'mcr',
          'mca',
          'mcapm',
          'osk',
          'osz',
          'osr',
          'rom',
          'sav',
          'gma',
          'litemod',
          'schem',
          'schematic',
          'nbs',
          'info',
          'rpgproject',
          'dat_new',
          'wbox',
          'player',
          'world',
          'plr',
          'wld',
        ];

        if (filenameLower.endsWith('.desktop') || filenameLower.endsWith('.appref-ms')) {
          return 'launch';
        }

        if (
          exeExts.includes(ext) ||
          !filename.includes('.') ||
          filenameLower === 'makefile' ||
          filenameLower.endsWith('makefile')
        ) {
          return 'settings_applications';
        }

        if (imageExts.includes(ext)) return 'image';
        if (docExts.includes(ext)) return 'description';
        if (sheetExts.includes(ext)) return 'grid_on';
        if (ext === 'pdf') return 'picture_as_pdf';
        if (archiveExts.includes(ext)) return 'archive';
        if (codeExts.includes(ext)) return 'code';
        if (gameExts.includes(ext)) return 'sports_esports';

        if (['txt', 'log', 'conf', 'ini', 'cfg', 'yaml', 'yml', 'toml', 'json'].includes(ext)) {
          return 'text_snippet';
        }

        if (['mp3', 'wav', 'ogg', 'flac', 'aac', 'wma', 'm4a'].includes(ext)) return 'audiotrack';
        if (
          ['mp4', 'webm', 'mov', 'avi', 'mkv', 'wmv', 'flv', 'm4v', 'mpeg', 'mpg'].includes(ext)
        ) {
          return 'videocam';
        }

        if (['epub', 'mobi', 'azw3'].includes(ext)) return 'menu_book';
        if (['ttf', 'otf', 'woff', 'woff2', 'eot'].includes(ext)) return 'font_download';
        if (['db', 'sqlite', 'sqlite3', 'db3', 'sqlitedb'].includes(ext)) return 'storage';

        return 'insert_drive_file';
      }

      function truncateFileName(fileName) {
        if (fileName.length <= 20) return fileName;
        return fileName.substring(0, 17) + '...';
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      async function loadFiles() {
        try {
          const response = await fetch('/api/files');
          const files = await response.json();

          if (!Array.isArray(files)) {
            console.error('Invalid files data:', files);
            filesGrid.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">
                  <span class="material-icons">error</span>
                </div>
                <p>ファイルの読み込みに失敗しました</p>
              </div>
            `;
            return;
          }

          if (files.length === 0) {
            filesGrid.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">
                  <span class="material-icons">folder_open</span>
                </div>
                <p>まだファイルがアップロードされていません</p>
                <a href="/upload" class="btn btn-primary">最初のファイルをアップロード</a>
              </div>
            `;
            return;
          }

          const fileElements = files
            .map(
              file => `
                <div class="file-card">
                  <div class="file-icon">
                    <span class="material-icons">${getFileIcon(file.originalName)}</span>
                  </div>
                  <div class="file-info">
                    <h4 class="file-name" onclick="showFileNamePopup('${
                      file.originalName
                    }')" title="タップしてファイル名を表示">${truncateFileName(
                file.originalName
              )}</h4>
                    <p class="file-size">${formatFileSize(file.size)}</p>
                  </div>
                  <div class="file-actions">
                    <a href="/files/${encodeURIComponent(
                      file.originalName
                    )}" class="action-btn" target="_blank" title="プレビュー">
                      <span class="material-icons">visibility</span>
                    </a>
                    <a href="/files/${encodeURIComponent(
                      file.originalName
                    )}" class="action-btn" download title="ダウンロード">
                      <span class="material-icons">download</span>
                    </a>
                    <button class="action-btn" onclick="showSharePopup(${JSON.stringify(
                      file
                    ).replace(/"/g, '&quot;')})" title="共有">
                      <span class="material-icons">share</span>
                    </button>
                    <button class="action-btn" onclick="showRenamePopup(${JSON.stringify(
                      file
                    ).replace(/"/g, '&quot;')})" title="名前変更">
                      <span class="material-icons">edit</span>
                    </button>
                    <button class="action-btn" onclick="deleteFile('${
                      file.originalName
                    }')" title="削除">
                      <span class="material-icons">delete</span>
                    </button>
                  </div>
                </div>
              `
            )
            .join('');

          filesGrid.innerHTML = fileElements;
        } catch (error) {
          console.error('ファイル読み込みエラー:', error);
          filesGrid.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">
                <span class="material-icons">error</span>
              </div>
              <p>ファイルの読み込みに失敗しました</p>
            </div>
          `;
        }
      }

      async function confirmRename() {
        if (!currentFile) return;

        const newName = newFileName.value.trim();
        if (!newName) {
          showToast('ファイル名を入力してください', 'error');
          return;
        }

        try {
          const response = await fetch(
            `/api/files/${encodeURIComponent(currentFile.originalName)}/rename`,
            {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ newName }),
            }
          );

          if (response.ok) {
            showToast('ファイル名を変更しました');
            closeRenamePopup();
            loadFiles();
          } else {
            showToast('ファイル名の変更に失敗しました', 'error');
          }
        } catch (error) {
          console.error('名前変更エラー:', error);
          showToast('ファイル名の変更に失敗しました', 'error');
        }
      }

      async function deleteFile(fileName) {
        currentFile = { originalName: fileName };
        const deleteConfirmMessage = `「${fileName}」を削除しますか？`;
        document.getElementById('deleteConfirmMessage').textContent = deleteConfirmMessage;
        document.getElementById('deletePopup').classList.add('show');
      }

      function closeDeletePopup() {
        document.getElementById('deletePopup').classList.remove('show');
        const deleteButton = document.querySelector('#deletePopup .btn-confirm');
        if (deleteButton) {
          deleteButton.disabled = false;
        }
      }

      async function confirmDelete() {
        if (!currentFile) return;

        const deleteButton = document.querySelector('#deletePopup .btn-confirm');
        if (deleteButton) {
          deleteButton.disabled = true;
        }

        try {
          closeDeletePopup();

          const response = await fetch(
            `/api/files/${encodeURIComponent(currentFile.originalName)}`,
            {
              method: 'DELETE',
            }
          );

          if (response.ok) {
            showToast('ファイルを削除しました');
            loadFiles();
          } else {
            showToast('ファイルの削除に失敗しました', 'error');
          }
        } catch (error) {
          console.error('削除エラー:', error);
          showToast('ファイルの削除に失敗しました', 'error');
        }
      }

      async function copyShareUrl() {
        try {
          await navigator.clipboard.writeText(shareUrl.value);
          showToast('URLをコピーしました');
        } catch (error) {
          showToast('URLのコピーに失敗しました', 'error');
        }
      }

      function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        mobileMenu.classList.toggle('active');
      }

      document.addEventListener('click', e => {
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');

        if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
          mobileMenu.classList.remove('active');
        }
      });

      fileNamePopup.addEventListener('click', e => {
        if (e.target === fileNamePopup) {
          closeFileNamePopup();
        }
      });

      renamePopup.addEventListener('click', e => {
        if (e.target === renamePopup) {
          closeRenamePopup();
        }
      });

      sharePopup.addEventListener('click', e => {
        if (e.target === sharePopup) {
          closeSharePopup();
        }
      });

      deletePopup.addEventListener('click', e => {
        if (e.target === deletePopup) {
          closeDeletePopup();
        }
      });

      themeToggle.addEventListener('click', toggleTheme);

      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (currentTheme === 'auto') {
          setTheme('auto');
        }
      });

      initTheme();
      loadFiles();
    </script>
  </body>
</html>
